<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Leaf Quiz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/AudioPlayer.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }

        body {
            font-size: 1.1em;
        }

        img {
            max-width: 100%;
        }

        button {
            background: lightblue;
            padding: 15px;
            cursor: pointer;
        }

        #options, #audio, button {
            margin: 2em;
        }

        #options li {
            cursor: pointer;
            padding: 0.5em 1em;
        }

        #options li:hover {
            background: lightblue;
        }
    </style>
    <!-- allow cors -->
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
</head>
<body>

<div id="quiz">
    <div id="img"></div>
    <div id="audio"></div>
    <div id="options"></div>
</div>

<script>
    const birds = [
        {
            code: 'radwar1',
            name: 'Radde\'s Warbler',
        },
        {
            code: 'duswar',
            name: 'Dusky Warbler',
        },
        {
            code: 'yeswar1',
            name: 'Yellow-streaked Warbler',
        },
        {
            code: 'butwar1',
            name: 'Buff-throated Warbler',
        },
        {
            code: 'arcwar1',
            name: 'Arctic Warbler',
        },
        {
            code: 'grewar3',
            name: 'Greenish Warbler',
        },
        {
            code: 'pllwar1',
            name: 'Pale-legged Leaf Warbler',
        },
        {
            code: 'eacwar1',
            name: 'Eastern Crowned Warbler',
        },
        {
            code: 'blylew1',
            name: 'Blyth\'s Leaf Warbler',
        },
        {
            code: 'davlew1',
            name: 'Davison\'s Leaf Warbler',
        },
        {
            code: 'yevwar1',
            name: 'Yellow-vented Warbler',
        },
        {
            code: 'subwar3',
            name: 'Sulphur-breasted Warbler',
        },
        {
            code: 'yebwar3',
            name: 'Yellow-browed Warbler',
        },
        {
            code: 'palwar5',
            name: 'Pallas\'s Leaf Warbler',
        },
        {
            code: 'astwar2',
            name: 'Ashy-throated Warbler',
        },
        {
            code: 'bubwar1',
            name: 'Buff-barred Warbler',
        },
    ];

    function nextQuiz() {
        // clear old quiz
        document.getElementById('img').innerHTML = '';
        document.getElementById('audio').innerHTML = '';
        document.getElementById('options').innerHTML = '';

        const bird = birds[Math.floor(Math.random() * birds.length)];
        const birdCode = bird.code;

        // load an image:
        const img = document.createElement('img');
        const caption = document.createElement('p');

        // fetch possible images from JSON: https://media.ebird.org/api/v1/search?taxonCode=radwar1&count=10&sort=rating_rank_desc&mediaType=a&regionCode=&locale=en_GB&taxaLocale=en_US
        fetch('https://media.ebird.org/api/v1/search?taxonCode=' + birdCode + '&count=10&sort=rating_rank_desc&mediaType=p&regionCode=&locale=en_GB&taxaLocale=en_US')
            .then(response => response.json())
            .then(data => {
                console.log(data);
                const images = data.results.content.map((item) => {
                    return {
                        url: item.mediaUrl,
                        ebird_link: item.eBirdChecklistUrl,
                    };
                });

                // pick a random image
                const image = images[Math.floor(Math.random() * images.length)];

                img.src = image.url;
                img.alt = image.ebird_link;
                caption.innerHTML = image.ebird_link;
            });

        // add image to quiz
        document.getElementById('img').appendChild(img);
        document.getElementById('img').appendChild(caption);

        // load audio (same url as image, except type = a)
        fetch('https://media.ebird.org/api/v1/search?taxonCode=' + birdCode + '&count=3&sort=rating_rank_desc&mediaType=a&regionCode=&locale=en_GB&taxaLocale=en_US')
            .then(response => response.json())
            .then(data => {
                console.log(data);
                const audios = data.results.content.map((item) => {
                    return {
                        url: item.mediaUrl,
                        ebird_link: item.eBirdChecklistUrl,
                        behaviors: item.behaviors,
                    };
                });

                // pick a random audio
                const audio = audios[Math.floor(Math.random() * audios.length)];

                // add audio to quiz
                const audioPlayer = document.createElement('audio');
                const caption = document.createElement('p');
                caption.innerHTML = audio.behaviors + " ::: " + audio.ebird_link;
                audioPlayer.controls = true;
                audioPlayer.src = audio.url;
                audioPlayer.alt = audio.ebird_link;
                document.getElementById('audio').appendChild(audioPlayer);
                document.getElementById('audio').appendChild(caption);
            });

        // now list some options for the user to pick from
        // grab 5 random birds, including the correct one
        const options = [];
        options.push(bird);
        while (options.length < 5) {
            const option = birds[Math.floor(Math.random() * birds.length)];
            if (!options.includes(option)) {
                options.push(option);
            }
        }
        // shuffle option order
        options.sort(() => Math.random() - 0.5);

        const optionList = document.createElement('ul');
        options.forEach((item) => {
            const option = document.createElement('li');
            option.innerHTML = item.name;
            option.onclick = () => {
                if (item.code === birdCode) {
                    option.style.color = 'green';
                    option.innerText = item.name + ' (correct)';
                    // unbind other options now...
                    options.forEach((item) => {
                        item.onclick = null;
                    });
                } else {
                    option.style.color = 'red';
                    option.innerText = item.name + ' (wrong)';
                }
            };
            optionList.appendChild(option);
        });
        document.getElementById('options').appendChild(optionList);

        //const audio = new Audio('https://media.ebird.org/api/v1/product/audio/'+bird+'/XC');
        //audio.play();
    }

    nextQuiz();
    // add a button for next quiz
    const nextButton = document.createElement('button');
    nextButton.innerHTML = 'Next';
    nextButton.onclick = nextQuiz;
    document.getElementById('quiz').appendChild(nextButton);
</script>


<style>
    /* Apply styles to the entire table */
    table {
        border-collapse: collapse;
        width: 100%;
        margin: 10px 0;
        font-family: Arial, sans-serif;
    }

    /* Style table headers */
    th {
        background-color: #f2f2f2;
        font-weight: bold;
        padding: 8px;
        text-align: left;
    }

    /* Style table rows */
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    /* Style table data cells */
    td {
        padding: 8px;
        text-align: left;
    }

    /* Add a border to the table and cells */
    table, th, td {
        border: 1px solid #ddd;
    }

    /* Highlight rows when hovered */
    tr:hover {
        background-color: #e6e6e6;
    }
    .template {
        display: none;
    }
</style>
<table id="id_features">
    <thead>
    <tr>
        <th>Species</th>
        <th>Dorsal Color</th>
        <th>Ventral Color</th>
        <th>Wing Bars</th>
        <th>Crowned</th>
        <th>Patterned Tertials</th>
        <th>Yellow rump patch</th>
        <th>White in tail</th>
        <th>Relative Size</th>
        <th>Tip of Mandible (Lower Jaw)</th>
        <th>Other</th>
    </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
    <tr>
        <td colspan="10">
            Data transcribed from:
            <a href="https://thesiamsociety.org/wp-content/uploads/2020/04/NHBSS_023_1-2e_Marshall_IdentificationOf.pdf">
                IDENTIFICATION OF LEAF WARBLERS
                IN THAILAND
                by
                Joe T. Marshall Jr. & Somsak Pantuwattana
            </a>
        </td>
    </tr>
    <tr class="template">
        <td class="name"></td>
        <td class="dorsal"></td>
        <td class="ventral"></td>
        <td class="wingbars"></td>
        <td class="crowned"></td>
        <td class="patterned"></td>
        <td class="yellow-rump"></td>
        <td class="white-tail"></td>
        <td class="size"></td>
        <td class="tip"></td>
        <td class="other"></td>
    </tr>
    </tfoot>
</table>
<script>
    const data = {
        "radwar1": {
            "Dorsal Color": "Brown",
            "Ventral Color": "Brown, whitish medially",
            "Relative Size": "Large",
            "Tip of Mandible (Lower Jaw)": "Dark"
        },
        "duswar": {
            "Dorsal Color": "Olive-brown",
            "Ventral Color": "Pale brown chest and flanks; rest dimorphic: either white or pale buff",
            "Relative Size": "Large",
            "Tip of Mandible (Lower Jaw)": "Pale",
            "Other": "Thicker bill than Radde's"
        },
        "yeswar1": {
            "Dorsal Color": "Olive-brown",
            "Ventral Color": "Gray anteriorly, yellowish posterially, all streaked with yellow",
            "Relative Size": "Large",
            "Tip of Mandible (Lower Jaw)": "Pale"
        },
        "butwar1": {
            "Dorsal Color": "Olive-buff",
            "Ventral Color": "Golden buff",
            "Relative Size": "Medium",
            "Tip of Mandible (Lower Jaw)": "Dark"
        },
        "arcwar1": {
            "Dorsal Color": "Olive-green",
            "Ventral Color": "Whitish, ",
            "Wing Bars": "small bars",
            "Relative Size": "Large",
            "Tip of Mandible (Lower Jaw)": "Pale",
            "White in tail": "narrow",
            "Other": "10th primary 1/4 length of #9"
        },
        "grewar3": {
            "Dorsal Color": "Olive-green",
            "Ventral Color": "Pale greenish-yellow",
            "Wing Bars": "small bars",
            "Relative Size": "Medium",
            "Tip of Mandible (Lower Jaw)": "Medium",
            "White in tail": "narrow",
            "Other": "Pale 10th primary, 1/2 length of #9"
        },
        "pllwar1": {
            "Dorsal Color": "Olive-brown, darker crown; golden brown on rump",
            "Ventral Color": "White, with brown flanks",
            "Wing Bars": "small bars",
            "Relative Size": "Large",
            "Tip of Mandible (Lower Jaw)": "Large",
            "White in tail": "narrow",
            "Other": "Pale Feet pale"
        },
        "eacwar1": {
            "Dorsal Color": "Olive-green",
            "Ventral Color": "Whitish, with contrasting lemon yellow vent",
            "Wing Bars": "small bars",
            "Crowned": "Crowned",
            "Relative Size": "Large",
            "Tip of Mandible (Lower Jaw)": "Large",
            "White in tail": "narrow",
            "Other": "Pale"
        },
        "blylew1": {
            "Dorsal Color": "Green",
            "Ventral Color": "Pale greenish-yellow",
            "Wing Bars": "double bars",
            "Crowned": "Crowned",
            "Relative Size": "Medium",
            "White in tail": "strong white border of inner web curving to include tip",
            "Tip of Mandible (Lower Jaw)": "Pale"
        },
        "davlew1": {
            "Dorsal Color": "Green",
            "Ventral Color": "Bright greenish-yellow brighter than Blyth's LW",
            "Wing Bars": "double bars",
            "Crowned": "Crowned",
            "Relative Size": "Medium, smaller than reguloides",
            "White in tail": "straight white inner web",
            "Tip of Mandible (Lower Jaw)": "Pale"
        },
        "yevwar1": {
            "Dorsal Color": "Olive-green",
            "Ventral Color": "Yellow throat and vent white belly",
            "Wing Bars": "small double bars",
            "Crowned": "Crowned",
            "Relative Size": "Medium",
            "White in tail": "narrow, pale yellow",
            "Tip of Mandible (Lower Jaw)": "Pale"
        },
        "subwar3": {
            "Dorsal Color": "Olive-green",
            "Ventral Color": "Yellow",
            "Wing Bars": "small double bars",
            "Crowned": "Crowned",
            "Relative Size": "Medium",
            "White in tail": "narrow, pale yellow",
            "Tip of Mandible (Lower Jaw)": "Pale"
        },
        "yebwar3": {
            "Dorsal Color": "Olive-green",
            "Ventral Color": "Whitish",
            "Wing Bars": "double bars",
            "Crowned": "faint or lacking",
            "Patterned Tertials": "Patterned",
            "Yellow rump patch": "Yellow",
            "White in tail": "Very narrow",
            "Relative Size": "small",
            "Tip of Mandible (Lower Jaw)": "Dark"
        },
        "palwar5": {
            "Dorsal Color": "Olive-green",
            "Ventral Color": "Pale greenish yellow becoming grayer anteriorly",
            "Wing Bars": "double bars",
            "Crowned": "Crowned",
            "Patterned Tertials": "Patterned",
            "Yellow rump patch": "Yellow",
            "White in tail": "Conspicuous white",
            "Relative Size": "Very small",
            "Tip of Mandible (Lower Jaw)": "Dark"
        },
        "astwar2": {
            "Dorsal Color": "Green",
            "Ventral Color": "Yellow-green",
            "Wing Bars": "double orange",
            "Crowned": "Crowned",
            "Patterned Tertials": "Patterned",
            "Yellow rump patch": "Yellow",
            "White in tail": "Conspicuous white",
            "Relative Size": "Medium",
            "Tip of Mandible (Lower Jaw)": "Dark"
        }
    };

    const table = document.querySelector('#id_features');
    const birdId = Object.keys(data);
    birdId.forEach((bird) => {
        // copy template and create new row
        const row = table.querySelector('.template').cloneNode(true);
        row.classList.remove('template');
        row.querySelector('.name').innerText = birds.filter((item) => item.code === bird)[0].name;
        row.querySelector('.dorsal').innerText = data[bird]['Dorsal Color'] ?? '';
        row.querySelector('.ventral').innerText = data[bird]['Ventral Color'] ?? '';
        row.querySelector('.wingbars').innerText = data[bird]['Wing Bars'] ?? '';
        row.querySelector('.crowned').innerText = data[bird]['Crowned'] ?? '';
        row.querySelector('.patterned').innerText = data[bird]['Patterned Tertials'] ?? '';
        row.querySelector('.yellow-rump').innerText = data[bird]['Yellow rump patch'] ?? '';
        row.querySelector('.white-tail').innerText = data[bird]['White in tail'] ?? '';
        row.querySelector('.size').innerText = data[bird]['Relative Size'] ?? '';
        row.querySelector('.tip').innerText = data[bird]['Tip of Mandible (Lower Jaw)'] ?? '';
        row.querySelector('.other').innerText = data[bird]['Other'] ?? '';
        table.querySelector('tbody').appendChild(row);
    });

</script>


</body>
</html>